<html>
    <head>
        <meta charset="UTF-8">
        <title>Спецификация Engine Archive</title>
    </head>
    <body style="font-family: 'Courier New', Courier, monospace">
        <h1>Спецификация формата Engine Archive</h1>
        <i>
            Данная спецификация поставляется вместе с Engine Runtime для ознакомления со стандартами особых форматов, в нём используемых.
            Спецификация не предназначена для самостоятельной разработки кодирующего/декодирующего ПО,
            Engine Software не несёт никакой ответственности за последствия такого рода самодеятельности.<br>
            Copyright &COPY; Engine Software, Емельянов Д. П. 2013-2018.<br><br>
        </i>
Архив предназначен для именованного и компактного хранения записей (файлов) потенциально большого размера.
Архивы базовой спецификации хранят только свойства, необходимые для программного доступа к записям.
Дополнительные (не обязательные) стандарты определяют применимые к записям методы сжатия и хранение расширенных метаданных.
Существует 2 вариации базового формата, отличающиеся разрядностью (32 бита или 64). 64-разрядная версия допускает размер архива более, чем 2<sup>31</sup> - 1.<br><br>
Для хранения данных на диске рекомендуется использовать расширение файла .ecs или .ecsa.
<h2>Базовый стандарт</h2>
В одном архиве допускается использование либо только 32-разрядных вариантов записей, либо только 64-разрядных.
<h3>Заголовок</h3>
Находится по адресу 0 в файле. Задаёт смещение в файле таблицы строк и базы, размер таблицы строк и количество файлов в архиве.
<table border="0">
    <tr><td align="center"><b><i>32-разрядный</i></b></td><td align="center"><b><i>64-разрядный</i></b></td></tr>
    <tr>
        <td valign="top">
            <table border="1">
                <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
                <tr><td>Signature</td><td>8</td><td>"ecs.1.0\0" - принадлежность файла к семейству Engine Content Storage</td></tr>
                <tr><td>SignatureEx</td><td>4</td><td>0x80000005 - подтип: файл архива</td></tr>
                <tr><td>FileCount</td><td>4</td><td>Количество файлов в архиве</td></tr>
                <tr><td>BaseOffset</td><td>4</td><td>Смещение базы записей</td></tr>
                <tr><td>StringsOffset</td><td>4</td><td>Смещение таблицы строк</td></tr>
                <tr><td>StringsSize</td><td>4</td><td>Размер таблицы строк</td></tr>
            </table>
        </td>
        <td valign="top">
            <table border="1">
                <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
                <tr><td>Signature</td><td>8</td><td>"ecs.1.0\0" - принадлежность файла к семейству Engine Content Storage</td></tr>
                <tr><td>SignatureEx</td><td>4</td><td>0xC0000005 - подтип: файл архива, 64-разрядный</td></tr>
                <tr><td>Reserved</td><td>4</td><td>0</td></tr>
                <tr><td>FileCount</td><td>8</td><td>Количество файлов в архиве</td></tr>
                <tr><td>BaseOffset</td><td>8</td><td>Смещение базы записей</td></tr>
                <tr><td>StringsOffset</td><td>8</td><td>Смещение таблицы строк</td></tr>
                <tr><td>StringsSize</td><td>8</td><td>Размер таблицы строк</td></tr>
                <tr><td>Unused1</td><td>8</td><td>0</td></tr>
                <tr><td>Unused2</td><td>8</td><td>0</td></tr>
            </table>
        </td>
    </tr>
</table>
<h3>Описатель файла</h3>
Массив данных записей идёт непосредственно после заголовка. Количество записей - FileCount. Каждая запись описывает отдельный файл.
<table border="0">
    <tr><td align="center"><b><i>32-разрядный</i></b></td><td align="center"><b><i>64-разрядный</i></b></td></tr>
    <tr>
        <td valign="top">
            <table border="1">
                <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>

                <tr><td>FileOffset</td><td>4</td><td>Смещение данных файла в файле архива относительно базы (BaseOffset)</td></tr>
                <tr><td>FileSize</td><td>4</td><td>Размер данных файла в байтах</td></tr>
                <tr><td>FileType</td><td>4</td><td>Тип файла</td></tr>
                <tr><td>FileID</td><td>4</td><td>Числовой идентификатор файла</td></tr>
                <tr><td>Custom</td><td>4</td><td>Данные персонального использования</td></tr>
                <tr><td>NameOffset</td><td>4</td><td>Смещение имени файла в таблице строк</td></tr>
            </table>
        </td>
        <td valign="top">
            <table border="1">
                <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>

                <tr><td>FileOffset</td><td>8</td><td>Смещение данных файла в файле архива относительно базы (BaseOffset)</td></tr>
                <tr><td>FileSize</td><td>8</td><td>Размер данных файла в байтах</td></tr>
                <tr><td>FileType</td><td>4</td><td>Тип файла</td></tr>
                <tr><td>FileID</td><td>4</td><td>Числовой идентификатор файла</td></tr>
                <tr><td>Custom</td><td>4</td><td>Данные персонального использования</td></tr>
                <tr><td>NameOffset</td><td>4</td><td>Смещение имени файла в таблице строк</td></tr>
                <tr><td>Unused1</td><td>8</td><td>0</td></tr>
                <tr><td>Unused2</td><td>8</td><td>0</td></tr>
            </table>
        </td>
    </tr>
</table>
Тип файла - строка из не более чем 4 ASCII символов, остаток поля заполняется нулями. Стандартные типы приведены ниже.<br>
Данные персонального использования определяются эксплуататором архива, спецификация их не определяет.<br>
Имя файла имеет формат строки в кодировке UTF16-LE, конец строки обозначается нулевым символом. Имена файлов считаются регистронезависимыми.
Допускается имитация пути (каталогов) в имени файла. В качестве разделителей каталогов используются символы "/". Не допускаются имена каталогов "." или "..",
повторы из более чем одного разделителя, а также символы Unicode с кодами менее 32.<br>
Пустая строка имени или типа интерпретируется как отсутствие имени или типа соответственно. Для файлов без типа рекомендуется установить идентификатор в 0.<br>
Для реализаций рекомендуется поддержка поиска файла в архиве по имени файла или по паре тип - идентификатор.
<h2>Стандартные типы файлов</h2>
Тип предназначен для определения не конкретного формата данных, а их назначения.
<table border="1">
    <tr><td><b>Строка типа</b></td><td><b>Тип данных</b></td></tr>
    <tr><td>TXT</td><td>Текстовый</td></tr>
    <tr><td>IMG</td><td>Изображение (возможно многокадровое)</td></tr>
    <tr><td>ICO</td><td>Значок</td></tr>
    <tr><td>CUR</td><td>Указатель мыши</td></tr>
    <tr><td>TEX</td><td>Текстура</td></tr>
    <tr><td>SCR</td><td>Интерпретируемый сценарий</td></tr>
    <tr><td>CTL</td><td>Библиотека текстур</td></tr>
    <tr><td>MDL</td><td>Трёхмерная модель</td></tr>
    <tr><td>MAP</td><td>Карта</td></tr>
    <tr><td>EXE</td><td>Исполняемый файл ОС</td></tr>
    <tr><td>TRE</td><td>Описатель дерева</td></tr>
    <tr><td>FNT</td><td>Шрифт</td></tr>
    <tr><td>SBX</td><td>Текстура неба (скайбокс)</td></tr>
    <tr><td>PRC</td><td>Класс частиц</td></tr>
    <tr><td>EMT</td><td>Описатель эмиттера</td></tr>
    <tr><td>REG</td><td>Реестр</td></tr>
    <tr><td>ARC</td><td>Архив</td></tr>
    <tr><td>UIT</td><td>Шаблон интефейса пользователя</td></tr>
    <tr><td>AMDE</td><td>Метаданные архива</td></tr>
</table>
<h2>Стандарт сжатия</h2>
Данные в архиве могут быть сжаты любым доступным методом сжатия. Предлагается использование метода цепного сжатия (Engine Runtime Chain Compression).<br>
Использование данного метода без метаданных или любого иного метода переносит ответственность за декомпрессию данных на эксплуататора.
В случае же цепного сжатия и использования метаданных реализация позволяет для каждого файла хранить флаг сжатия, автоматически сжимать и извлекать данные при доступе к ним.
<h2>Стандарт метаданных</h2>
Метаданные архива кодируются в виде реестра (Engine Registry). Данные реестра помещаются в архив в виде дополнительного файла со следующими свойствами:
<ul>
    <li>Тип файла: AMDE</li>
    <li>Идентификатор файла: FFFFFFFF (шестнадцатеричная запись)</li>
    <li>Персональные данные: 0</li>
    <li>Имя: отсутствует</li>
    <li>Сжатие: отсутствует</li>
</ul>
Кроме того, файл должен быть последним в списке файлов архива. Файл, не отвечающий указанным свойствам, не считается хранилищем метаданных.
<h3>Структура реестра метаданных</h3>
В корне реестра располагаются каталоги.
Каждый каталог соответствует некоторому файлу: его имя является номером файла в архиве (отсчёт с 1), записанным в десятичной системе счисления без незначащих нулей.
Некоторые файлы могут не иметь ссылающегося на них каталога, если у них метаданных нет. Метаданные файла хранятся в соответствующем ему каталоге в виде полей.
<h3>Поля метаданных файла</h3>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Тип данных</b></td><td><b>Значение</b></td></tr>
    <tr><td>"Creation Time"</td><td>Временной</td><td>Время создания файла</td></tr>
    <tr><td>"Access Time"</td><td>Временной</td><td>Время последнего чтения из файла</td></tr>
    <tr><td>"Alter Time"</td><td>Временной</td><td>Время последнего изменения файла</td></tr>
    <tr><td>"Compressed"</td><td>Логический</td><td>Флаг сжатия</td></tr>
    <tr><td>"_" + &lt;имя атрибута&gt;</td><td>Строковый</td><td>Значение атрибута</td></tr>
</table>
Флаг сжатия указывает на то, что файл был сжат цепным методом. Сжатый файл может и не иметь данной отметки.
Размещение несжатых данных с установленным флагом сжатия не допускается.<br>
Файл может иметь много атрибутов или ни одного. Их интерпретация определяется эксплуататором.
Имя атрибута рекомендуется составлять из латинских букв и цифр, пробела и символов "-" и "_". На значение атрибута ограничения не накладываются.<br>
Один или несколько полей метаданных могут отсутствовать.
В этом случае считается, что для них выбраны значения по умолчанию (1 января 1 года, 00:00:00.000 UTC для времени, "не сжат" для сжатия, пустая строка для атрибута).
    </body>
</html>