<html>
    <head>
        <meta charset="UTF-8">
        <title>Спецификация Engine Registry</title>
    </head>
    <body style="font-family: 'Courier New', Courier, monospace">
        <h1>Спецификация формата Engine Registry</h1>
        <i>
            Данная спецификация поставляется вместе с Engine Runtime для ознакомления со стандартами особых форматов, в нём используемых.
            Спецификация не предназначена для самостоятельной разработки кодирующего/декодирующего ПО,
            Engine Software не несёт никакой ответственности за последствия такого рода самодеятельности.<br>
            Copyright &COPY; Engine Software, Емельянов Д. П. 2015-2018.<br><br>
        </i>
Реестр представляет из себя древовидную структуру для именованного хранения данных небольшого размера.
Все узлы дерева имеют строковую метку-имя, некоторые узлы, не имеющие дочерних, ассоциированы также со значением некоторого типа.
Для доступа к значению используется путь до соответствующего узла от корня, записанный в схожей с путём к файлу форме.
Данный формат имеет своей целью долговременное хранение указанных структур на диске или передачу их по сетевому каналу.<br><br>
Для хранения данных на диске рекомендуется использовать расширение файла .ecs или .ecsr.
<h2>Заголовок. Расположен по смещению 0 в файле.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>Signature</td><td>8</td><td>"ecs.1.0\0" - принадлежность файла к семейству Engine Content Storage</td></tr>
    <tr><td>SignatureEx</td><td>4</td><td>0x80000004 - подтип: файл реестра</td></tr>
    <tr><td>Version</td><td>4</td><td>0x00000000 (зарезервировано под расширение формата)</td></tr>
    <tr><td>DataOffset</td><td>4</td><td>Смещение блока данных относительно начала файла (в байтах)</td></tr>
    <tr><td>DataSize</td><td>4</td><td>Размер блока данных (в байтах)</td></tr>
    <tr><td>RootOffset</td><td>4</td><td>Смещение записи корневого узла реестра относительно начала блока данных (в байтах)</td></tr>
</table>
<h2>Запись узла реестра.</h2>Здесь и далее все смещения и размеры указаны в байтах относительно начала блока данных.
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>NodeCount</td><td>4</td><td>Количество дочерних узлов в данном узле</td></tr>
    <tr><td>ValueCount</td><td>4</td><td>Количество записей-значений в данном узле</td></tr>
    <tr><td>NodeOffset</td><td>4 * NodeCount</td><td>Массив смещений записей дочерних узлов</td></tr>
    <tr><td>NodeNameOffset</td><td>4 * NodeCount</td><td>Массив смещений имён дочерних узлов. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueOffset</td><td>4 * ValueCount</td><td>Массив смещений записей-значений</td></tr>
</table>
<h2>Запись значения целочисленного (Integer) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>1 - целочисленный тип</td></tr>
    <tr><td>Value</td><td>4</td><td>Непосредственно значение (int32)</td></tr>
</table>
<h2>Запись значения вещественного (Float) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>2 - вещественный тип</td></tr>
    <tr><td>Value</td><td>4</td><td>Непосредственно значение (float)</td></tr>
</table>
<h2>Запись значения логического (Boolean) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>3 - логический тип</td></tr>
    <tr><td>Value</td><td>4</td><td>Непосредственно значение: 0 для "ложь", 1 для "истина"</td></tr>
</table>
<h2>Запись значения строкового (String) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>4 - строковый тип</td></tr>
    <tr><td>Value</td><td>4</td><td>Сдвиг содержимого строки. Строка хранится в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
</table>
<i>Следующие типы не поддерживаются классической реализацией.</i><br>
<h2>Запись значения длинного целочисленного (LongInteger) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>5 - длинный целочисленный тип</td></tr>
    <tr><td>Value</td><td>8</td><td>Непосредственно значение (int64)</td></tr>
</table>
<h2>Запись значения длинного вещественного (LongFloat) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>6 - длинный вещественный тип</td></tr>
    <tr><td>Value</td><td>8</td><td>Непосредственно значение (double)</td></tr>
</table>
<h2>Запись значения цветового (Color) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>7 - цветовой тип</td></tr>
    <tr><td>Value</td><td>4</td><td>Непосредственно значение в формате R8G8B8A8</td></tr>
</table>
<h2>Запись значения временного (Time) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>8 - временной тип</td></tr>
    <tr><td>Value</td><td>8</td><td>Непосредственно значение - время, исчисленное количеством миллисекунд, прошедших с 00:00:00,000 UTC 1 января 1 года</td></tr>
</table>
<h2>Запись значения двоичного (Binary) типа.</h2>
<table border="1">
    <tr><td><b>Имя поля</b></td><td><b>Размер в байтах</b></td><td><b>Значение</b></td></tr>
    <tr><td>ValueName</td><td>4</td><td>Смещение имени значения. Имена хранятся в кодировке UTF16-LE, конец обозначен нулевым символом</td></tr>
    <tr><td>ValueType</td><td>4</td><td>9 - двоичный тип</td></tr>
    <tr><td>ValueSize</td><td>4</td><td>Размер двоичных данных</td></tr>
    <tr><td>Value</td><td>4</td><td>Сдвиг двоичных данных</td></tr>
</table>
<h2>Замечания.</h2>
Любое значение имеет имя. Поэтому ссылка на имя хранится непосредственно в значении.<br>
Существует узел (корневой узел), который не имеет имени. Поэтому имена узлов хранятся в узле-родителе.<br>
Все имена считаются регистронезависимыми. Рекомендуется хранить записи в алфавитном порядке. Не рекомендуется наличие сущностей с одинаковым именем или с пустым именем.
Допускается совпадение имён узла и значения, так как при адресации из контекста видно, к чему идёт обращение.<br>
В именах не допускаются обратная и прямая дроби.<br>
Первые 8 байт у любой записи значения имеют единый смысл. Прочитав их, можно определить тип значения, и как следствие, трактовку оставшихся данных.
    </body>
</html>